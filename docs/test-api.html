<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Test - OfertaRadar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #1557b0;
    }
    button:active {
      transform: scale(0.98);
    }
    .result {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      overflow-x: auto;
      border-left: 4px solid #1a73e8;
    }
    .success {
      border-left-color: #0a7a2f;
      background: #f0fff4;
    }
    .error {
      border-left-color: #b00020;
      background: #fff0f0;
    }
    input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 300px;
    }
    .callback-info {
      background: #fffbea;
      border: 1px solid #ffd591;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 13px;
    }
    .callback-count {
      display: inline-block;
      background: #1a73e8;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>üîå API Test Page - Callbacks in Action</h1>
  <p>This page demonstrates how callbacks work when calling your HTTPS APIs.</p>

  <!-- Health Check -->
  <div class="section">
    <h2>1. Health Check API</h2>
    <p>Test if the server is running and database is connected.</p>
    <button onclick="testHealthAPI()">Call /api/health</button>
    <div class="callback-info">
      <strong>Callbacks involved:</strong>
      <span class="callback-count">3</span>
      <br>1. Button click callback
      <br>2. fetch().then() - receives response
      <br>3. .then() - processes JSON data
    </div>
    <div id="health-result"></div>
  </div>

  <!-- Get All Products -->
  <div class="section">
    <h2>2. Get All Products</h2>
    <p>Fetch demo products from the API.</p>
    <button onclick="testGetProducts()">Call /api/products</button>
    <div class="callback-info">
      <strong>Callbacks involved:</strong>
      <span class="callback-count">3</span>
      <br>1. Button click callback
      <br>2. fetch().then() - receives response
      <br>3. .then() - processes product data
    </div>
    <div id="products-result"></div>
  </div>

  <!-- Search Products -->
  <div class="section">
    <h2>3. Search Products</h2>
    <p>Search for products with filters.</p>
    <input type="text" id="searchQuery" placeholder="Enter search query (e.g., laptop)" value="laptop">
    <button onclick="testSearchAPI()">Call /api/products/search</button>
    <div class="callback-info">
      <strong>Callbacks involved:</strong>
      <span class="callback-count">4+</span>
      <br>1. Button click callback
      <br>2. fetch().then() - receives response
      <br>3. .then() - processes search results
      <br>4. forEach() - loops through products (callback per product!)
    </div>
    <div id="search-result"></div>
  </div>

  <!-- Get Single Product -->
  <div class="section">
    <h2>4. Get Product by SKU</h2>
    <p>Fetch a specific product by its SKU.</p>
    <input type="text" id="productSku" placeholder="Enter SKU (e.g., demo-1)" value="demo-1">
    <button onclick="testGetProduct()">Call /api/products/:sku</button>
    <div class="callback-info">
      <strong>Callbacks involved:</strong>
      <span class="callback-count">3</span>
      <br>1. Button click callback
      <br>2. fetch().then() - receives response
      <br>3. .then() - processes single product
    </div>
    <div id="product-result"></div>
  </div>

  <!-- Callback Chain Demo -->
  <div class="section">
    <h2>5. Callback Chain Demo</h2>
    <p>See multiple API calls chained together with callbacks.</p>
    <button onclick="testCallbackChain()">Chain Multiple API Calls</button>
    <div class="callback-info">
      <strong>Callbacks involved:</strong>
      <span class="callback-count">9+</span>
      <br>1. Button click
      <br>2-3. Health check (2 callbacks)
      <br>4-5. Get all products (2 callbacks)
      <br>6-7. Search products (2 callbacks)
      <br>8-9. Get specific product (2 callbacks)
    </div>
    <div id="chain-result"></div>
  </div>

  <script>
    const BASE_URL = 'https://localhost:3000';

    // Helper function to display results
    function displayResult(elementId, data, isError = false) {
      const element = document.getElementById(elementId);
      element.className = 'result ' + (isError ? 'error' : 'success');
      element.textContent = JSON.stringify(data, null, 2);
    }

    // 1. Health Check API
    function testHealthAPI() {
      console.log('Calling /api/health...');
      displayResult('health-result', { loading: '‚è≥ Loading...' });

      // CALLBACK #1: fetch().then()
      fetch(`${BASE_URL}/api/health`)
        .then(function(response) {  // ‚Üê CALLBACK executed when response arrives
          console.log('Response received:', response.status);
          return response.json();
        })
        .then(function(data) {  // ‚Üê CALLBACK executed when JSON is parsed
          console.log('Data received:', data);
          displayResult('health-result', data);
        })
        .catch(function(error) {  // ‚Üê ERROR CALLBACK if something fails
          console.error('Error:', error);
          displayResult('health-result', { error: error.message }, true);
        });
    }

    // 2. Get All Products
    function testGetProducts() {
      console.log('Calling /api/products...');
      displayResult('products-result', { loading: '‚è≥ Loading...' });

      fetch(`${BASE_URL}/api/products`)
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          // Show only first 3 products for brevity
          if (data.products && data.products.length > 3) {
            data.products = data.products.slice(0, 3);
            data.note = `Showing 3 of ${data.count} products. ${data.note}`;
          }
          displayResult('products-result', data);
        })
        .catch(function(error) {
          displayResult('products-result', { error: error.message }, true);
        });
    }

    // 3. Search Products
    function testSearchAPI() {
      const query = document.getElementById('searchQuery').value;
      console.log('Searching for:', query);
      displayResult('search-result', { loading: '‚è≥ Searching...' });

      fetch(`${BASE_URL}/api/products/search?q=${encodeURIComponent(query)}`)
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          console.log('Search results:', data);
          displayResult('search-result', data);
        })
        .catch(function(error) {
          displayResult('search-result', { error: error.message }, true);
        });
    }

    // 4. Get Single Product
    function testGetProduct() {
      const sku = document.getElementById('productSku').value;
      console.log('Fetching product:', sku);
      displayResult('product-result', { loading: '‚è≥ Loading...' });

      fetch(`${BASE_URL}/api/products/${encodeURIComponent(sku)}`)
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          console.log('Product data:', data);
          displayResult('product-result', data);
        })
        .catch(function(error) {
          displayResult('product-result', { error: error.message }, true);
        });
    }

    // 5. Callback Chain Demo
    function testCallbackChain() {
      displayResult('chain-result', { loading: '‚è≥ Starting callback chain...' });
      
      const results = {
        step1: null,
        step2: null,
        step3: null,
        step4: null
      };

      // STEP 1: Health check
      fetch(`${BASE_URL}/api/health`)
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          results.step1 = { health: data.status };
          displayResult('chain-result', { ...results, current: 'Step 1 complete ‚úì' });
          
          // STEP 2: Get all products (nested callback)
          return fetch(`${BASE_URL}/api/products`);
        })
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          results.step2 = { productCount: data.count };
          displayResult('chain-result', { ...results, current: 'Step 2 complete ‚úì' });
          
          // STEP 3: Search for "laptop"
          return fetch(`${BASE_URL}/api/products/search?q=laptop`);
        })
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          results.step3 = { searchResults: data.products ? data.products.length : 0 };
          displayResult('chain-result', { ...results, current: 'Step 3 complete ‚úì' });
          
          // STEP 4: Get first product
          return fetch(`${BASE_URL}/api/products/demo-1`);
        })
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          results.step4 = { productName: data.product ? data.product.name : 'N/A' };
          results.completed = 'üéâ All callbacks executed successfully!';
          displayResult('chain-result', results);
        })
        .catch(function(error) {
          results.error = error.message;
          displayResult('chain-result', results, true);
        });
    }

    // Show info on load
    console.log('üî• API Test Page Ready!');
    console.log('Base URL:', BASE_URL);
    console.log('Open DevTools (F12) to see callback execution logs');
  </script>
</body>
</html>
